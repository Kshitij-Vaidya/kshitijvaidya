"use strict";(function(){let s,m,d,p,l=[],u=!1,i,w=acquireVsCodeApi();w||console.log("Error: vscode api not found"),window.addEventListener("message",e=>{switch(e.data.type){case"initCanvas":{I(e.data.value);break}case"resetGlyphBitmaps":{l=[];break}case"renderPage":{C(e.data.value);break}case"scroll":{i=Number.MAX_SAFE_INTEGER,E(e.data.value);break}case"drawbox":{B(e.data.value);break}}});let x=e=>{if(i){i=void 0;return}i=setTimeout(()=>{a()},200);function a(){clearTimeout(i),i=void 0,w.postMessage({command:"webviewScrolled",scrollY:window.scrollY})}};window.addEventListener("scroll",x);function I(e){let a=document.getElementById("cnv");a&&(s=e.marginPixels,m=e.pageWidth,d=e.pageHeight,p=e.pageGap,a.width=m,a.height=e.pageCount*(d+p)),u=!1}function C(e){let a=e.pageIndex,r=e.pageSource,g=e.pageGlyphs,n=document.getElementById("cnv"),y=n?n.getContext("2d",{alpha:!1}):void 0;if(r&&n&&y){let v=new OffscreenCanvas(m,d),c=v.getContext("2d");if(c){c.fillStyle="white",c.fillRect(0,0,m,d),c.fillStyle="black";let T=r.images.map(async o=>{let h=new Image;h.src=documentPath+"/"+o.fileName.replace(".eps",".svg");try{await h.decode(),c.drawImage(h,s+o.x,s+o.y,o.w,o.h)}catch(P){console.log(P)}});Promise.all(T).then(()=>{r.rules.forEach(t=>c.fillRect(s+t.x,s+t.y,t.w,t.h));let o=new OffscreenCanvas(1,1),h=o.getContext("2d");g.forEach(t=>{l[t.glyphPath.fontNum]||(l[t.glyphPath.fontNum]=[]),l[t.glyphPath.fontNum][t.glyphPath.glyphIndex]||(l[t.glyphPath.fontNum][t.glyphPath.glyphIndex]=[]);let f=l[t.glyphPath.fontNum][t.glyphPath.glyphIndex][t.glyphPath.size];if(!f&&t.glyphPath){o.width=t.glyphPath.width,o.height=t.glyphPath.height;let N=new Path2D(t.glyphPath.path);h.fill(N),f=o.transferToImageBitmap(),l[t.glyphPath.fontNum][t.glyphPath.glyphIndex][t.glyphPath.size]=f}f&&c.drawImage(f,s+t.x,s+t.y)});let P=v.transferToImageBitmap();y.drawImage(P,0,a*(d+p)),w.postMessage({command:"pageRendered",pageIndex:a}),u=!0})}}}function E(e){window.scrollTo(0,e.vPos)}function B(e){let a=setTimeout(()=>{u&&r()},100);function r(){clearTimeout(a);let g=document.getElementById("cnv"),n=g?g.getContext("2d",{alpha:!1}):void 0;n&&(n.translate(.5,.5),n.lineWidth=1,n.strokeStyle=e.color,n.strokeRect(e.x,e.y,e.w,e.h),n.setTransform(1,0,0,1,0,0))}}})();
